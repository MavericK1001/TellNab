import{r as i,j as e}from"./index-VYHjnPjf.js";const I=window.SUPPORT_AGENT_CHAT_WS_URL||"";function O(s){return["SUPPORT_MEMBER","MODERATOR","ADMIN"].includes(String(s.role).toUpperCase())}function L({user:s,authToken:t}){const[l,j]=i.useState(!1),[m,r]=i.useState(!1),[p,g]=i.useState([]),[o,c]=i.useState(""),[C,w]=i.useState([]),[b,D]=i.useState(""),[N,R]=i.useState(0),v=i.useRef(null);i.useEffect(()=>{if(!O(s)||!I)return;const n=new WebSocket(I);return v.current=n,n.onopen=()=>{r(!0),n.send(JSON.stringify({type:"auth",token:t||null,userId:s.id,role:s.role,name:s.name}))},n.onclose=()=>r(!1),n.onerror=()=>r(!1),n.onmessage=f=>{var A;try{const u=JSON.parse(String(f.data||"{}"));if(u.type==="presence"&&Array.isArray(u.agents)){g(u.agents),!o&&((A=u.agents[0])!=null&&A.id)&&c(u.agents[0].id);return}if(u.type==="dm"){const E={id:u.id||crypto.randomUUID(),from:u.from,to:u.to,body:u.body,at:u.at||new Date().toISOString()};w(x=>[...x,E]),l||(R(S=>S+1),new Audio("data:audio/wav;base64,UklGRjwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YRgAAAAA/////wAAAP///wAAAA==").play().catch(()=>{}))}}catch{}},()=>{n.close()}},[t,s.id,s.name,s.role,l,o]);const h=p.find(n=>n.id===o)||null,d=i.useMemo(()=>C.filter(n=>n.from===o||n.to===o),[C,o]);function k(n){n.preventDefault(),!(!b.trim()||!o||!v.current)&&(v.current.send(JSON.stringify({type:"dm",to:o,body:b.trim()})),w(f=>[...f,{id:crypto.randomUUID(),from:s.id,to:o,body:b.trim(),at:new Date().toISOString()}]),D(""))}return O(s)?e.jsxs("div",{className:"agent-chat-fab-wrap",children:[e.jsxs("button",{type:"button",className:"agent-chat-fab",onClick:()=>{j(n=>!n),R(0)},children:["Agent Chat"," ",N>0?e.jsx("span",{className:"unread-pill",children:N}):null]}),l?e.jsxs("section",{className:"agent-chat-panel",children:[e.jsxs("header",{children:[e.jsx("strong",{children:"Internal Agent Chat"}),e.jsx("small",{className:m?"ok":"error",children:m?"Online":"Offline"})]}),e.jsxs("div",{className:"agent-chat-body",children:[e.jsxs("aside",{children:[p.length===0?e.jsx("p",{className:"subtle",children:"No online agents"}):null,p.map(n=>e.jsx("button",{className:"ghost",onClick:()=>c(n.id),children:n.name},n.id))]}),e.jsxs("div",{children:[e.jsx("p",{className:"subtle",children:h?`Chat with ${h.name}`:"Select an agent"}),e.jsx("div",{className:"agent-thread",children:d.map(n=>e.jsx("p",{className:n.from===s.id?"mine":"other",children:n.body},n.id))}),e.jsxs("form",{onSubmit:k,className:"agent-chat-input",children:[e.jsx("input",{value:b,onChange:n=>D(n.target.value),placeholder:"Message"}),e.jsx("button",{type:"submit",disabled:!o,children:"Send"})]})]})]})]}):null]}):null}function B({lines:s=3}){return e.jsx("div",{className:"skeleton-wrap","aria-hidden":"true",children:Array.from({length:s}).map((t,l)=>e.jsx("div",{className:"skeleton-line"},l))})}function M({label:s,value:t,hint:l}){return e.jsxs("article",{className:"stat-card",children:[e.jsx("p",{className:"stat-label",children:s}),e.jsx("h3",{className:"stat-value",children:t}),l?e.jsx("p",{className:"stat-hint",children:l}):null]})}function G({title:s,subtitle:t}){return e.jsxs("header",{className:"app-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:s}),e.jsx("p",{className:"subtle",children:t})]}),e.jsx("div",{className:"online-pill",children:"â— Live"})]})}function W({user:s,onLogout:t,roleView:l}){return e.jsxs("aside",{className:"app-sidebar",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"TellNab Support"}),e.jsxs("h2",{children:[l.toUpperCase()," Workspace"]}),e.jsx("p",{className:"subtle",children:s.name}),e.jsx("p",{className:"subtle",children:s.role})]}),e.jsxs("nav",{className:"sidebar-nav",children:[e.jsx("button",{type:"button",className:"ghost",children:"Dashboard"}),e.jsx("button",{type:"button",className:"ghost",children:"Tickets"}),e.jsx("button",{type:"button",className:"ghost",children:"Conversations"}),l!=="user"?e.jsx("button",{type:"button",className:"ghost",children:"Agents"}):null,l==="admin"?e.jsx("button",{type:"button",className:"ghost",children:"Role Control"}):null]}),e.jsx("button",{type:"button",onClick:t,children:"Sign out"})]})}function $({mine:s,body:t,timestamp:l,senderLabel:j,seen:m}){return e.jsx("div",{className:`message-row ${s?"mine":"other"}`,children:e.jsxs("div",{className:"message-bubble",children:[j?e.jsx("p",{className:"message-sender",children:j}):null,e.jsx("p",{children:t}),e.jsxs("div",{className:"message-meta",children:[l?e.jsx("time",{children:new Date(l).toLocaleString()}):null,s?e.jsx("span",{children:m?"Seen":"Sent"}):null]})]})})}function q({ticket:s,currentUser:t,messages:l,onSend:j,readOnly:m}){const[r,p]=i.useState(""),g=i.useMemo(()=>s?[...s.description?[{id:`${s.id}-seed`,body:s.description,senderId:s.customer_id,senderRole:"MEMBER",createdAt:s.created_at||s.updated_at||new Date().toISOString()}]:[],...l]:[],[s,l]);async function o(c){c.preventDefault(),!(!r.trim()||m)&&(await j(r.trim()),p(""))}return s?e.jsxs("section",{className:"chat-window",children:[e.jsxs("div",{className:"chat-window-header",children:[e.jsx("h3",{children:s.subject}),e.jsx("p",{className:"subtle",children:s.ticket_number})]}),e.jsx("div",{className:"chat-thread",children:g.length===0?e.jsx("p",{className:"subtle",children:"No messages yet."}):g.map(c=>e.jsx($,{mine:c.senderId===t.id,body:c.body,timestamp:c.createdAt,senderLabel:c.senderId===t.id?"You":c.senderRole||"Agent",seen:!0},c.id))}),e.jsxs("form",{className:"chat-input",onSubmit:o,children:[e.jsx("textarea",{value:r,onChange:c=>p(c.target.value),rows:3,placeholder:m?"Read-only":"Type a message...",disabled:m}),e.jsxs("div",{className:"chat-actions",children:[e.jsx("span",{className:"attach-pill",children:"Attach file"}),e.jsx("button",{type:"submit",disabled:m||!r.trim(),children:"Send"})]})]})]}):e.jsx("section",{className:"chat-window empty-state",children:"Select a ticket to view conversation."})}function H(s){return String(s||"").toUpperCase()}function P({value:s,tone:t="status"}){const l=H(s),j=`badge ${t} ${l.toLowerCase()}`;return e.jsx("span",{className:j,children:l.replaceAll("_"," ")})}function Q({ticket:s,selected:t,onOpen:l}){return e.jsxs("button",{type:"button",className:`ticket-card ${t?"selected":""}`,onClick:()=>l(s.id),children:[e.jsxs("div",{className:"ticket-card-top",children:[e.jsx("strong",{children:s.ticket_number}),e.jsx(P,{value:s.status,tone:"status"})]}),e.jsx("p",{className:"ticket-title",children:s.subject}),e.jsxs("div",{className:"ticket-card-top",children:[e.jsx(P,{value:s.priority,tone:"priority"}),e.jsx("small",{children:new Date(s.sla_due_at).toLocaleString()})]})]})}function F(s){const t=String(s.role||"").toUpperCase();return t==="ADMIN"?"admin":t==="SUPPORT_MEMBER"||t==="MODERATOR"?"agent":"user"}function V(s){const{user:t,authToken:l,loading:j,status:m,tickets:r,selectedTicketId:p,messages:g,roleOptions:o,adminUsers:c,onOpenTicket:C,onCreateTicket:w,onSendMessage:b,onRefresh:D,onUpdateStatus:N,onRoleUpdate:R,onLogout:v}=s,h=F(t),d=i.useMemo(()=>r.find(a=>a.id===p)||null,[r,p]),[k,n]=i.useState(""),[f,A]=i.useState(""),[u,E]=i.useState("MEDIUM"),[x,S]=i.useState("all"),U=i.useMemo(()=>{if(h==="agent"){if(x==="assigned")return r.filter(a=>a.assigned_agent_id===t.id);if(x==="unassigned")return r.filter(a=>!a.assigned_agent_id)}return r},[r,x,h,t.id]);async function _(a){a.preventDefault(),await w({subject:k,description:f,priority:u}),n(""),A(""),E("MEDIUM")}const T=r.filter(a=>["NEW","OPEN","PENDING"].includes(String(a.status).toUpperCase())).length;return e.jsxs("div",{className:"app-shell",children:[e.jsx(W,{user:t,roleView:h,onLogout:v}),e.jsxs("main",{className:"app-main",children:[e.jsx(G,{title:h==="user"?"User Dashboard":h==="agent"?"Agent Dashboard":"Admin Dashboard",subtitle:"Modern support workspace powered by your existing APIs"}),e.jsxs("section",{className:"stats-grid",children:[e.jsx(M,{label:"Total tickets",value:r.length}),e.jsx(M,{label:"Open tickets",value:T}),e.jsx(M,{label:"My role",value:t.role}),e.jsx(M,{label:"Queue",value:h==="agent"?x:"my_tickets",hint:"Real-time safe refresh"})]}),h==="user"?e.jsxs("section",{className:"panel",children:[e.jsx("h3",{children:"Create ticket"}),e.jsxs("form",{className:"grid",onSubmit:_,children:[e.jsx("input",{value:k,onChange:a=>n(a.target.value),placeholder:"Subject",minLength:5,required:!0}),e.jsxs("select",{value:u,onChange:a=>E(a.target.value),children:[e.jsx("option",{value:"LOW",children:"Low"}),e.jsx("option",{value:"MEDIUM",children:"Medium"}),e.jsx("option",{value:"HIGH",children:"High"}),e.jsx("option",{value:"URGENT",children:"Urgent"})]}),e.jsx("textarea",{value:f,onChange:a=>A(a.target.value),rows:3,minLength:10,required:!0}),e.jsx("button",{type:"submit",children:"Create ticket"})]})]}):null,e.jsxs("section",{className:"workspace-grid",children:[e.jsxs("section",{className:"panel",children:[e.jsxs("div",{className:"list-head",children:[e.jsx("h3",{children:h==="agent"?"Agent queue":"Tickets"}),e.jsxs("div",{className:"support-btn-row",children:[h==="agent"?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"ghost",onClick:()=>S("all"),children:"All"}),e.jsx("button",{className:"ghost",onClick:()=>S("assigned"),children:"Assigned"}),e.jsx("button",{className:"ghost",onClick:()=>S("unassigned"),children:"Unassigned"})]}):null,e.jsx("button",{className:"ghost",onClick:()=>D(),children:"Refresh"})]})]}),j?e.jsx(B,{lines:6}):U.length===0?e.jsx("div",{className:"empty-state",children:"No tickets found in this queue."}):e.jsx("div",{className:"ticket-list-modern",children:U.map(a=>e.jsx(Q,{ticket:a,selected:p===a.id,onOpen:C},a.id))})]}),e.jsxs("section",{className:"panel",children:[e.jsxs("div",{className:"support-btn-row",children:[e.jsx("button",{className:"ghost",disabled:!d,onClick:()=>d&&N(d.id,"OPEN"),children:"OPEN"}),e.jsx("button",{className:"ghost",disabled:!d,onClick:()=>d&&N(d.id,"PENDING"),children:"PENDING"}),e.jsx("button",{className:"ghost",disabled:!d,onClick:()=>d&&N(d.id,"RESOLVED"),children:"RESOLVED"})]}),e.jsx(q,{ticket:d,currentUser:t,messages:g,onSend:a=>d?b(d.id,a):Promise.resolve(),readOnly:!d})]})]}),h==="admin"?e.jsxs("section",{className:"panel",children:[e.jsx("h3",{children:"Role Control"}),e.jsx("p",{className:"subtle",children:"Dynamic role rendering backed by API"}),e.jsx("div",{className:"admin-role-grid",children:c.map(a=>e.jsxs("article",{className:"ticket-card",children:[e.jsx("p",{children:e.jsx("strong",{children:a.name})}),e.jsx("p",{className:"subtle",children:a.email}),e.jsx("select",{value:a.role,onChange:y=>R(a.id,y.target.value),children:o.map(y=>e.jsx("option",{value:y,children:y},y))})]},a.id))})]}):null,m?e.jsx("p",{className:"status-message",children:m}):null]}),e.jsx(L,{user:t,authToken:l})]})}export{V as DashboardPage};
