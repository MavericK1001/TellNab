import{r as c,u as $,j as e}from"./index-BKXjtM0m.js";function T(s){return["SUPPORT_MEMBER","MODERATOR","ADMIN"].includes(String(s.role).toUpperCase())}function F({user:s}){const[n,i]=c.useState(!1),[o,d]=c.useState([]),[a,p]=c.useState(""),[h,b]=c.useState([]),[m,g]=c.useState(""),[N,A]=c.useState(0),{connected:r,onlineAgents:f,subscribeAgentDm:y,sendAgentDm:j}=$();c.useEffect(()=>{if(!T(s))return;const l=y(x=>{const S={id:x.id,from:x.from,to:x.to,body:x.body,at:x.at};b(C=>[...C,S]),n||(A(w=>w+1),new Audio("data:audio/wav;base64,UklGRjwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YRgAAAAA/////wAAAP///wAAAA==").play().catch(()=>{}))});return()=>{l()}},[n,y,s.id,s.role]),c.useEffect(()=>{var x;const l=f.filter(S=>S.id!==s.id);d(l),!a&&((x=l[0])!=null&&x.id)&&p(l[0].id)},[a,f,s.id]);const u=o.find(l=>l.id===a)||null,k=c.useMemo(()=>h.filter(l=>l.from===a||l.to===a),[h,a]);function D(l){l.preventDefault(),!(!m.trim()||!a)&&(j(a,m.trim()),b(x=>[...x,{id:crypto.randomUUID(),from:s.id,to:a,body:m.trim(),at:new Date().toISOString()}]),g(""))}return T(s)?e.jsxs("div",{className:"agent-chat-fab-wrap",children:[e.jsxs("button",{type:"button",className:"agent-chat-fab",onClick:()=>{i(l=>!l),A(0)},children:["Agent Chat"," ",N>0?e.jsx("span",{className:"unread-pill",children:N}):null]}),n?e.jsxs("section",{className:"agent-chat-panel",children:[e.jsxs("header",{children:[e.jsx("strong",{children:"Internal Agent Chat"}),e.jsx("small",{className:r?"ok":"error",children:r?"Online":"Offline"})]}),e.jsxs("div",{className:"agent-chat-body",children:[e.jsxs("aside",{children:[o.length===0?e.jsx("p",{className:"subtle",children:"No online agents"}):null,o.map(l=>e.jsx("button",{className:"ghost",onClick:()=>p(l.id),children:l.name},l.id))]}),e.jsxs("div",{children:[e.jsx("p",{className:"subtle",children:u?`Chat with ${u.name}`:"Select an agent"}),e.jsx("div",{className:"agent-thread",children:k.map(l=>e.jsx("p",{className:l.from===s.id?"mine":"other",children:l.body},l.id))}),e.jsxs("form",{onSubmit:D,className:"agent-chat-input",children:[e.jsx("input",{value:m,onChange:l=>g(l.target.value),placeholder:"Message"}),e.jsx("button",{type:"submit",disabled:!a,children:"Send"})]})]})]})]}):null]}):null}function H({lines:s=3}){return e.jsx("div",{className:"skeleton-wrap","aria-hidden":"true",children:Array.from({length:s}).map((n,i)=>e.jsx("div",{className:"skeleton-line"},i))})}function E({label:s,value:n,hint:i}){return e.jsxs("article",{className:"stat-card",children:[e.jsx("p",{className:"stat-label",children:s}),e.jsx("h3",{className:"stat-value",children:n}),i?e.jsx("p",{className:"stat-hint",children:i}):null]})}function Q({title:s,subtitle:n,connected:i=!1,onToggleSidebar:o}){return e.jsxs("header",{className:"app-header",children:[e.jsx("button",{type:"button",className:"mobile-menu-btn",onClick:o,children:"☰"}),e.jsxs("div",{children:[e.jsx("h1",{children:s}),e.jsx("p",{className:"subtle",children:n})]}),e.jsxs("div",{className:"live-status-wrap",children:[e.jsx("div",{className:`live-avatar ${i?"online":"offline"}`,children:e.jsx("span",{className:"live-dot"})}),e.jsx("div",{className:"online-pill",children:i?"Online":"Offline"})]})]})}function V({user:s,onLogout:n,roleView:i,activeSection:o,isOpen:d,onClose:a,onNavigate:p}){function h(b){p(b),a()}return e.jsxs("aside",{className:`app-sidebar ${d?"open":""}`,children:[e.jsx("button",{type:"button",className:"mobile-close-btn",onClick:a,children:"✕"}),e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"TellNab Support"}),e.jsxs("h2",{children:[i.toUpperCase()," Workspace"]}),e.jsx("p",{className:"subtle",children:s.name}),e.jsx("p",{className:"subtle",children:s.role})]}),e.jsxs("nav",{className:"sidebar-nav",children:[e.jsx("button",{type:"button",className:`ghost ${o==="dashboard"?"active-tab":""}`,onClick:()=>h("dashboard"),children:"Dashboard"}),e.jsx("button",{type:"button",className:`ghost ${o==="tickets"?"active-tab":""}`,onClick:()=>h("tickets"),children:"Tickets"}),e.jsx("button",{type:"button",className:`ghost ${o==="conversations"?"active-tab":""}`,onClick:()=>h("conversations"),children:"Conversations"}),i!=="user"?e.jsx("button",{type:"button",className:`ghost ${o==="agents"?"active-tab":""}`,onClick:()=>h("agents"),children:"Agents"}):null,i==="admin"?e.jsx("button",{type:"button",className:`ghost ${o==="role-control"?"active-tab":""}`,onClick:()=>h("role-control"),children:"Role Control"}):null]}),e.jsx("button",{type:"button",onClick:n,children:"Sign out"})]})}function z({mine:s,body:n,timestamp:i,senderLabel:o,seen:d,fileUrl:a,fileName:p,fileType:h,fileSize:b,pending:m}){const g=!!(a&&(h||"").startsWith("image/"));return e.jsx("div",{className:`message-row ${s?"mine":"other"}`,children:e.jsxs("div",{className:"message-bubble",children:[o?e.jsx("p",{className:"message-sender",children:o}):null,e.jsx("p",{children:n}),a?g?e.jsx("a",{href:a,target:"_blank",rel:"noreferrer",className:"attachment-image-wrap",children:e.jsx("img",{src:a,alt:p||"attachment",className:"attachment-image"})}):e.jsxs("div",{className:"attachment-file-card",children:[e.jsx("p",{className:"attachment-name",children:p||"Attachment"}),e.jsxs("p",{className:"attachment-meta",children:[h||"file"," •"," ",b?`${Math.ceil(b/1024)} KB`:"size n/a"]}),e.jsxs("div",{className:"support-btn-row",children:[e.jsx("a",{href:a,target:"_blank",rel:"noreferrer",children:"Open"}),e.jsx("a",{href:a,download:p||"attachment",children:"Download"})]})]}):null,e.jsxs("div",{className:"message-meta",children:[i?e.jsx("time",{children:new Date(i).toLocaleString()}):null,s?e.jsx("span",{children:m?"Sending...":d?"Seen":"Sent"}):null]})]})})}function Z({ticket:s,currentUser:n,messages:i,onSend:o,readOnly:d}){const[a,p]=c.useState(""),[h,b]=c.useState(null),[m,g]=c.useState(!1),N=c.useMemo(()=>s?[...s.description?[{id:`${s.id}-seed`,body:s.description,senderId:s.customer_id,senderRole:"MEMBER",createdAt:s.created_at||s.updated_at||new Date().toISOString()}]:[],...i]:[],[s,i]);async function A(r){r.preventDefault(),!(!a.trim()&&!h||d)&&(g(!0),await o({text:a.trim(),file:h}),g(!1),p(""),b(null))}return s?e.jsxs("section",{className:"chat-window",children:[e.jsxs("div",{className:"chat-window-header",children:[e.jsx("h3",{children:s.subject}),e.jsx("p",{className:"subtle",children:s.ticket_number})]}),e.jsx("div",{className:"chat-thread",children:N.length===0?e.jsx("p",{className:"subtle",children:"No messages yet."}):N.map(r=>e.jsx(z,{mine:r.senderId===n.id,body:r.body,timestamp:r.createdAt,fileUrl:r.fileUrl,fileName:r.fileName,fileType:r.fileType,fileSize:r.fileSize,pending:r.pending,senderLabel:r.senderId===n.id?"You":r.senderRole||"Agent",seen:!0},r.id))}),e.jsxs("form",{className:"chat-input",onSubmit:A,children:[e.jsx("textarea",{value:a,onChange:r=>p(r.target.value),rows:3,placeholder:d?"Read-only":"Type a message...",disabled:d||m}),e.jsxs("div",{className:"chat-attach-row",children:[e.jsxs("label",{className:"attach-pill attach-input-label",children:["Attach file",e.jsx("input",{type:"file",onChange:r=>{var f;return b(((f=r.target.files)==null?void 0:f[0])||null)},disabled:d||m})]}),h?e.jsx("span",{className:"subtle file-preview-name",children:h.name}):null,m?e.jsx("span",{className:"subtle",children:"Uploading..."}):null]}),e.jsxs("div",{className:"chat-actions",children:[e.jsx("span",{className:"attach-pill",children:h?"Attachment ready":"No attachment"}),e.jsx("button",{type:"submit",disabled:d||m||!a.trim()&&!h,children:m?"Sending...":"Send"})]})]})]}):e.jsx("section",{className:"chat-window empty-state",children:"Select a ticket to view conversation."})}function Y(s){return String(s||"").toUpperCase()}function _({value:s,tone:n="status"}){const i=Y(s),o=`badge ${n} ${i.toLowerCase()}`;return e.jsx("span",{className:o,children:i.replaceAll("_"," ")})}function K({ticket:s,selected:n,onOpen:i}){return e.jsxs("button",{type:"button",className:`ticket-card ${n?"selected":""}`,onClick:()=>i(s.id),children:[e.jsxs("div",{className:"ticket-card-top",children:[e.jsx("strong",{children:s.ticket_number}),e.jsx(_,{value:s.status,tone:"status"})]}),e.jsx("p",{className:"ticket-title",children:s.subject}),e.jsxs("div",{className:"ticket-card-top",children:[e.jsx(_,{value:s.priority,tone:"priority"}),e.jsx("small",{children:new Date(s.sla_due_at).toLocaleString()})]})]})}function X(s){const n=String(s.role||"").toUpperCase();return n==="ADMIN"?"admin":n==="SUPPORT_MEMBER"||n==="MODERATOR"?"agent":"user"}function ee(s){const{user:n,loading:i,status:o,tickets:d,selectedTicketId:a,messages:p,roleOptions:h,adminUsers:b,onOpenTicket:m,onCreateTicket:g,onSendMessage:N,onRefresh:A,onUpdateStatus:r,onRoleUpdate:f,onLogout:y}=s,j=X(n),u=c.useMemo(()=>d.find(t=>t.id===a)||null,[d,a]),[k,D]=c.useState(""),[l,x]=c.useState(""),[S,C]=c.useState("MEDIUM"),[w,M]=c.useState("all"),[B,O]=c.useState(!1),[I,L]=c.useState(()=>window.location.hash.replace("#","").trim()||"dashboard"),{connected:G}=$();function R(t){L(t),window.history.replaceState(null,"",`#${t}`);const v=t==="dashboard"?"dashboard-stats":t==="tickets"?"tickets-section":t==="conversations"?"conversations-section":t==="agents"?"agents-section":"role-control-section",P=document.getElementById(v);P&&P.scrollIntoView({behavior:"smooth",block:"start"})}c.useEffect(()=>{R(I)},[I]);const U=c.useMemo(()=>{if(j==="agent"){if(w==="assigned")return d.filter(t=>t.assigned_agent_id===n.id);if(w==="unassigned")return d.filter(t=>!t.assigned_agent_id)}return d},[d,w,j,n.id]);async function W(t){t.preventDefault(),await g({subject:k,description:l,priority:S}),D(""),x(""),C("MEDIUM")}const q=d.filter(t=>["NEW","OPEN","PENDING"].includes(String(t.status).toUpperCase())).length;return e.jsxs("div",{className:"app-shell",children:[e.jsx(V,{user:n,roleView:j,onLogout:y,activeSection:I,isOpen:B,onClose:()=>O(!1),onNavigate:R}),e.jsxs("main",{className:"app-main",children:[e.jsx(Q,{title:j==="user"?"User Dashboard":j==="agent"?"Agent Dashboard":"Admin Dashboard",subtitle:"Modern support workspace powered by your existing APIs",connected:G,onToggleSidebar:()=>O(t=>!t)}),e.jsxs("section",{id:"dashboard-stats",className:"stats-grid",children:[e.jsx(E,{label:"Total tickets",value:d.length}),e.jsx(E,{label:"Open tickets",value:q}),e.jsx(E,{label:"My role",value:n.role}),e.jsx(E,{label:"Queue",value:j==="agent"?w:"my_tickets",hint:"Real-time safe refresh"})]}),j==="user"?e.jsxs("section",{className:"panel",children:[e.jsx("h3",{children:"Create ticket"}),e.jsxs("form",{className:"grid",onSubmit:W,children:[e.jsx("input",{value:k,onChange:t=>D(t.target.value),placeholder:"Subject",minLength:5,required:!0}),e.jsxs("select",{value:S,onChange:t=>C(t.target.value),children:[e.jsx("option",{value:"LOW",children:"Low"}),e.jsx("option",{value:"MEDIUM",children:"Medium"}),e.jsx("option",{value:"HIGH",children:"High"}),e.jsx("option",{value:"URGENT",children:"Urgent"})]}),e.jsx("textarea",{value:l,onChange:t=>x(t.target.value),rows:3,minLength:10,required:!0}),e.jsx("button",{type:"submit",children:"Create ticket"})]})]}):null,e.jsxs("section",{className:"workspace-grid",children:[e.jsxs("section",{id:"tickets-section",className:"panel",children:[e.jsxs("div",{className:"list-head",children:[e.jsx("h3",{children:j==="agent"?"Agent queue":"Tickets"}),e.jsxs("div",{className:"support-btn-row",children:[j==="agent"?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"ghost",onClick:()=>M("all"),children:"All"}),e.jsx("button",{className:"ghost",onClick:()=>M("assigned"),children:"Assigned"}),e.jsx("button",{className:"ghost",onClick:()=>M("unassigned"),children:"Unassigned"})]}):null,e.jsx("button",{className:"ghost",onClick:()=>A(),children:"Refresh"})]})]}),i?e.jsx(H,{lines:6}):U.length===0?e.jsx("div",{className:"empty-state",children:"No tickets found in this queue."}):e.jsx("div",{className:"ticket-list-modern",children:U.map(t=>e.jsx(K,{ticket:t,selected:a===t.id,onOpen:m},t.id))})]}),e.jsxs("section",{id:"conversations-section",className:"panel",children:[e.jsxs("div",{className:"support-btn-row",children:[e.jsx("button",{className:"ghost",disabled:!u,onClick:()=>u&&r(u.id,"OPEN"),children:"OPEN"}),e.jsx("button",{className:"ghost",disabled:!u,onClick:()=>u&&r(u.id,"PENDING"),children:"PENDING"}),e.jsx("button",{className:"ghost",disabled:!u,onClick:()=>u&&r(u.id,"RESOLVED"),children:"RESOLVED"})]}),e.jsx(Z,{ticket:u,currentUser:n,messages:p,onSend:t=>u?N(u.id,t):Promise.resolve(),readOnly:!u})]})]}),j!=="user"?e.jsxs("section",{id:"agents-section",className:"panel",children:[e.jsx("h3",{children:"Online agents"}),e.jsx("p",{className:"subtle",children:"Use floating internal chat for private messaging."})]}):null,j==="admin"?e.jsxs("section",{id:"role-control-section",className:"panel",children:[e.jsx("h3",{children:"Role Control"}),e.jsx("p",{className:"subtle",children:"Dynamic role rendering backed by API"}),e.jsx("div",{className:"admin-role-grid",children:b.map(t=>e.jsxs("article",{className:"ticket-card",children:[e.jsx("p",{children:e.jsx("strong",{children:t.name})}),e.jsx("p",{className:"subtle",children:t.email}),e.jsx("select",{value:t.role,onChange:v=>f(t.id,v.target.value),children:h.map(v=>e.jsx("option",{value:v,children:v},v))})]},t.id))})]}):null,o?e.jsx("p",{className:"status-message",children:o}):null]}),e.jsx(F,{user:n})]})}export{ee as DashboardPage};
