import{r as c,u as B,j as e}from"./index-CdRlLUl6.js";function _(s){return["SUPPORT_MEMBER","MODERATOR","ADMIN"].includes(String(s.role).toUpperCase())}function H({user:s}){const[a,i]=c.useState(!1),[o,m]=c.useState([]),[n,h]=c.useState(""),[d,b]=c.useState([]),[p,g]=c.useState(""),[f,A]=c.useState(0),{connected:r,onlineAgents:N,subscribeAgentDm:C,sendAgentDm:M}=B();c.useEffect(()=>{if(!_(s))return;const l=C(x=>{const S={id:x.id,from:x.from,to:x.to,body:x.body,at:x.at};b(w=>[...w,S]),a||(A(y=>y+1),new Audio("data:audio/wav;base64,UklGRjwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YRgAAAAA/////wAAAP///wAAAA==").play().catch(()=>{}))});return()=>{l()}},[a,C,s.id,s.role]),c.useEffect(()=>{var x;const l=N.filter(S=>S.id!==s.id);m(l),!n&&((x=l[0])!=null&&x.id)&&h(l[0].id)},[n,N,s.id]);const j=o.find(l=>l.id===n)||null,u=c.useMemo(()=>d.filter(l=>l.from===n||l.to===n),[d,n]);function k(l){l.preventDefault(),!(!p.trim()||!n)&&(M(n,p.trim()),b(x=>[...x,{id:crypto.randomUUID(),from:s.id,to:n,body:p.trim(),at:new Date().toISOString()}]),g(""))}return _(s)?e.jsxs("div",{className:"agent-chat-fab-wrap",children:[e.jsxs("button",{type:"button",className:"agent-chat-fab",onClick:()=>{i(l=>!l),A(0)},children:["Agent Chat"," ",f>0?e.jsx("span",{className:"unread-pill",children:f}):null]}),a?e.jsxs("section",{className:"agent-chat-panel",children:[e.jsxs("header",{children:[e.jsx("strong",{children:"Internal Agent Chat"}),e.jsx("small",{className:r?"ok":"error",children:r?"Online":"Offline"})]}),e.jsxs("div",{className:"agent-chat-body",children:[e.jsxs("aside",{children:[o.length===0?e.jsx("p",{className:"subtle",children:"No online agents"}):null,o.map(l=>e.jsx("button",{className:"ghost",onClick:()=>h(l.id),children:l.name},l.id))]}),e.jsxs("div",{children:[e.jsx("p",{className:"subtle",children:j?`Chat with ${j.name}`:"Select an agent"}),e.jsx("div",{className:"agent-thread",children:u.map(l=>e.jsx("p",{className:l.from===s.id?"mine":"other",children:l.body},l.id))}),e.jsxs("form",{onSubmit:k,className:"agent-chat-input",children:[e.jsx("input",{value:p,onChange:l=>g(l.target.value),placeholder:"Message"}),e.jsx("button",{type:"submit",disabled:!n,children:"Send"})]})]})]})]}):null]}):null}function Q({lines:s=3}){return e.jsx("div",{className:"skeleton-wrap","aria-hidden":"true",children:Array.from({length:s}).map((a,i)=>e.jsx("div",{className:"skeleton-line"},i))})}function E({label:s,value:a,hint:i}){return e.jsxs("article",{className:"stat-card",children:[e.jsx("p",{className:"stat-label",children:s}),e.jsx("h3",{className:"stat-value",children:a}),i?e.jsx("p",{className:"stat-hint",children:i}):null]})}function V({title:s,subtitle:a,connected:i=!1,onToggleSidebar:o}){return e.jsxs("header",{className:"app-header",children:[e.jsx("button",{type:"button",className:"mobile-menu-btn",onClick:o,children:"☰"}),e.jsxs("div",{children:[e.jsx("h1",{children:s}),e.jsx("p",{className:"subtle",children:a})]}),e.jsxs("div",{className:"live-status-wrap",children:[e.jsx("div",{className:`live-avatar ${i?"online":"offline"}`,children:e.jsx("span",{className:"live-dot"})}),e.jsx("div",{className:"online-pill",children:i?"Online":"Offline"})]})]})}function z({user:s,onLogout:a,roleView:i,activeSection:o,isOpen:m,onClose:n,onNavigate:h}){function d(b){h(b),n()}return e.jsxs("aside",{className:`app-sidebar ${m?"open":""}`,children:[e.jsx("button",{type:"button",className:"mobile-close-btn",onClick:n,children:"✕"}),e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"TellNab Support"}),e.jsxs("h2",{children:[i.toUpperCase()," Workspace"]}),e.jsx("p",{className:"subtle",children:s.name}),e.jsx("p",{className:"subtle",children:s.role})]}),e.jsxs("nav",{className:"sidebar-nav",children:[e.jsx("button",{type:"button",className:`ghost ${o==="dashboard"?"active-tab":""}`,onClick:()=>d("dashboard"),children:"Dashboard"}),e.jsx("button",{type:"button",className:`ghost ${o==="tickets"?"active-tab":""}`,onClick:()=>d("tickets"),children:"Tickets"}),e.jsx("button",{type:"button",className:`ghost ${o==="conversations"?"active-tab":""}`,onClick:()=>d("conversations"),children:"Conversations"}),i!=="user"?e.jsx("button",{type:"button",className:`ghost ${o==="agents"?"active-tab":""}`,onClick:()=>d("agents"),children:"Agents"}):null,i==="admin"?e.jsx("button",{type:"button",className:`ghost ${o==="role-control"?"active-tab":""}`,onClick:()=>d("role-control"),children:"Role Control"}):null]}),e.jsx("button",{type:"button",onClick:a,children:"Sign out"})]})}function Z({mine:s,body:a,timestamp:i,senderLabel:o,seen:m,fileUrl:n,fileName:h,fileType:d,fileSize:b,pending:p}){const g=!!(n&&(d||"").startsWith("image/"));return e.jsx("div",{className:`message-row ${s?"mine":"other"}`,children:e.jsxs("div",{className:"message-bubble",children:[o?e.jsx("p",{className:"message-sender",children:o}):null,e.jsx("p",{children:a}),n?g?e.jsx("a",{href:n,target:"_blank",rel:"noreferrer",className:"attachment-image-wrap",children:e.jsx("img",{src:n,alt:h||"attachment",className:"attachment-image"})}):e.jsxs("div",{className:"attachment-file-card",children:[e.jsx("p",{className:"attachment-name",children:h||"Attachment"}),e.jsxs("p",{className:"attachment-meta",children:[d||"file"," • ",b?`${Math.ceil(b/1024)} KB`:"size n/a"]}),e.jsxs("div",{className:"support-btn-row",children:[e.jsx("a",{href:n,target:"_blank",rel:"noreferrer",children:"Open"}),e.jsx("a",{href:n,download:h||"attachment",children:"Download"})]})]}):null,e.jsxs("div",{className:"message-meta",children:[i?e.jsx("time",{children:new Date(i).toLocaleString()}):null,s?e.jsx("span",{children:p?"Sending...":m?"Seen":"Sent"}):null]})]})})}function Y({ticket:s,currentUser:a,messages:i,onSend:o,readOnly:m}){const[n,h]=c.useState(""),[d,b]=c.useState(null),[p,g]=c.useState(!1),f=c.useMemo(()=>s?[...s.description?[{id:`${s.id}-seed`,body:s.description,senderId:s.customer_id,senderRole:"MEMBER",createdAt:s.created_at||s.updated_at||new Date().toISOString()}]:[],...i]:[],[s,i]);async function A(r){r.preventDefault(),!(!n.trim()&&!d||m)&&(g(!0),await o({text:n.trim(),file:d}),g(!1),h(""),b(null))}return s?e.jsxs("section",{className:"chat-window",children:[e.jsxs("div",{className:"chat-window-header",children:[e.jsx("h3",{children:s.subject}),e.jsx("p",{className:"subtle",children:s.ticket_number})]}),e.jsx("div",{className:"chat-thread",children:f.length===0?e.jsx("p",{className:"subtle",children:"No messages yet."}):f.map(r=>e.jsx(Z,{mine:r.senderId===a.id,body:r.body,timestamp:r.createdAt,fileUrl:r.fileUrl,fileName:r.fileName,fileType:r.fileType,fileSize:r.fileSize,pending:r.pending,senderLabel:r.senderId===a.id?"You":r.senderRole||"Agent",seen:!0},r.id))}),e.jsxs("form",{className:"chat-input",onSubmit:A,children:[e.jsx("textarea",{value:n,onChange:r=>h(r.target.value),rows:3,placeholder:m?"Read-only":"Type a message...",disabled:m||p}),e.jsxs("div",{className:"chat-attach-row",children:[e.jsxs("label",{className:"attach-pill attach-input-label",children:["Attach file",e.jsx("input",{type:"file",onChange:r=>{var N;return b(((N=r.target.files)==null?void 0:N[0])||null)},disabled:m||p})]}),d?e.jsx("span",{className:"subtle file-preview-name",children:d.name}):null,p?e.jsx("span",{className:"subtle",children:"Uploading..."}):null]}),e.jsxs("div",{className:"chat-actions",children:[e.jsx("span",{className:"attach-pill",children:d?"Attachment ready":"No attachment"}),e.jsx("button",{type:"submit",disabled:m||p||!n.trim()&&!d,children:p?"Sending...":"Send"})]})]})]}):e.jsx("section",{className:"chat-window empty-state",children:"Select a ticket to view conversation."})}function K(s){return String(s||"").toUpperCase()}function $({value:s,tone:a="status"}){const i=K(s),o=`badge ${a} ${i.toLowerCase()}`;return e.jsx("span",{className:o,children:i.replaceAll("_"," ")})}function X({ticket:s,selected:a,onOpen:i}){return e.jsxs("button",{type:"button",className:`ticket-card ${a?"selected":""}`,onClick:()=>i(s.id),children:[e.jsxs("div",{className:"ticket-card-top",children:[e.jsx("strong",{children:s.ticket_number}),e.jsx($,{value:s.status,tone:"status"})]}),e.jsx("p",{className:"ticket-title",children:s.subject}),e.jsxs("div",{className:"ticket-card-top",children:[e.jsx($,{value:s.priority,tone:"priority"}),e.jsx("small",{children:new Date(s.sla_due_at).toLocaleString()})]})]})}function J(s){const a=String(s.role||"").toUpperCase();return a==="ADMIN"?"admin":a==="SUPPORT_MEMBER"||a==="MODERATOR"?"agent":"user"}function se(s){const{user:a,authToken:i,loading:o,status:m,tickets:n,selectedTicketId:h,messages:d,roleOptions:b,adminUsers:p,onOpenTicket:g,onCreateTicket:f,onSendMessage:A,onRefresh:r,onUpdateStatus:N,onRoleUpdate:C,onLogout:M}=s,j=J(a),u=c.useMemo(()=>n.find(t=>t.id===h)||null,[n,h]),[k,l]=c.useState(""),[x,S]=c.useState(""),[w,y]=c.useState("MEDIUM"),[D,I]=c.useState("all"),[L,O]=c.useState(!1),[R,G]=c.useState(()=>window.location.hash.replace("#","").trim()||"dashboard"),{connected:W}=B();function U(t){G(t),window.history.replaceState(null,"",`#${t}`);const v=t==="dashboard"?"dashboard-stats":t==="tickets"?"tickets-section":t==="conversations"?"conversations-section":t==="agents"?"agents-section":"role-control-section",T=document.getElementById(v);T&&T.scrollIntoView({behavior:"smooth",block:"start"})}c.useEffect(()=>{U(R)},[]);const P=c.useMemo(()=>{if(j==="agent"){if(D==="assigned")return n.filter(t=>t.assigned_agent_id===a.id);if(D==="unassigned")return n.filter(t=>!t.assigned_agent_id)}return n},[n,D,j,a.id]);async function q(t){t.preventDefault(),await f({subject:k,description:x,priority:w}),l(""),S(""),y("MEDIUM")}const F=n.filter(t=>["NEW","OPEN","PENDING"].includes(String(t.status).toUpperCase())).length;return e.jsxs("div",{className:"app-shell",children:[e.jsx(z,{user:a,roleView:j,onLogout:M,activeSection:R,isOpen:L,onClose:()=>O(!1),onNavigate:U}),e.jsxs("main",{className:"app-main",children:[e.jsx(V,{title:j==="user"?"User Dashboard":j==="agent"?"Agent Dashboard":"Admin Dashboard",subtitle:"Modern support workspace powered by your existing APIs",connected:W,onToggleSidebar:()=>O(t=>!t)}),e.jsxs("section",{id:"dashboard-stats",className:"stats-grid",children:[e.jsx(E,{label:"Total tickets",value:n.length}),e.jsx(E,{label:"Open tickets",value:F}),e.jsx(E,{label:"My role",value:a.role}),e.jsx(E,{label:"Queue",value:j==="agent"?D:"my_tickets",hint:"Real-time safe refresh"})]}),j==="user"?e.jsxs("section",{className:"panel",children:[e.jsx("h3",{children:"Create ticket"}),e.jsxs("form",{className:"grid",onSubmit:q,children:[e.jsx("input",{value:k,onChange:t=>l(t.target.value),placeholder:"Subject",minLength:5,required:!0}),e.jsxs("select",{value:w,onChange:t=>y(t.target.value),children:[e.jsx("option",{value:"LOW",children:"Low"}),e.jsx("option",{value:"MEDIUM",children:"Medium"}),e.jsx("option",{value:"HIGH",children:"High"}),e.jsx("option",{value:"URGENT",children:"Urgent"})]}),e.jsx("textarea",{value:x,onChange:t=>S(t.target.value),rows:3,minLength:10,required:!0}),e.jsx("button",{type:"submit",children:"Create ticket"})]})]}):null,e.jsxs("section",{className:"workspace-grid",children:[e.jsxs("section",{id:"tickets-section",className:"panel",children:[e.jsxs("div",{className:"list-head",children:[e.jsx("h3",{children:j==="agent"?"Agent queue":"Tickets"}),e.jsxs("div",{className:"support-btn-row",children:[j==="agent"?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"ghost",onClick:()=>I("all"),children:"All"}),e.jsx("button",{className:"ghost",onClick:()=>I("assigned"),children:"Assigned"}),e.jsx("button",{className:"ghost",onClick:()=>I("unassigned"),children:"Unassigned"})]}):null,e.jsx("button",{className:"ghost",onClick:()=>r(),children:"Refresh"})]})]}),o?e.jsx(Q,{lines:6}):P.length===0?e.jsx("div",{className:"empty-state",children:"No tickets found in this queue."}):e.jsx("div",{className:"ticket-list-modern",children:P.map(t=>e.jsx(X,{ticket:t,selected:h===t.id,onOpen:g},t.id))})]}),e.jsxs("section",{id:"conversations-section",className:"panel",children:[e.jsxs("div",{className:"support-btn-row",children:[e.jsx("button",{className:"ghost",disabled:!u,onClick:()=>u&&N(u.id,"OPEN"),children:"OPEN"}),e.jsx("button",{className:"ghost",disabled:!u,onClick:()=>u&&N(u.id,"PENDING"),children:"PENDING"}),e.jsx("button",{className:"ghost",disabled:!u,onClick:()=>u&&N(u.id,"RESOLVED"),children:"RESOLVED"})]}),e.jsx(Y,{ticket:u,currentUser:a,messages:d,onSend:t=>u?A(u.id,t):Promise.resolve(),readOnly:!u})]})]}),j!=="user"?e.jsxs("section",{id:"agents-section",className:"panel",children:[e.jsx("h3",{children:"Online agents"}),e.jsx("p",{className:"subtle",children:"Use floating internal chat for private messaging."})]}):null,j==="admin"?e.jsxs("section",{id:"role-control-section",className:"panel",children:[e.jsx("h3",{children:"Role Control"}),e.jsx("p",{className:"subtle",children:"Dynamic role rendering backed by API"}),e.jsx("div",{className:"admin-role-grid",children:p.map(t=>e.jsxs("article",{className:"ticket-card",children:[e.jsx("p",{children:e.jsx("strong",{children:t.name})}),e.jsx("p",{className:"subtle",children:t.email}),e.jsx("select",{value:t.role,onChange:v=>C(t.id,v.target.value),children:b.map(v=>e.jsx("option",{value:v,children:v},v))})]},t.id))})]}):null,m?e.jsx("p",{className:"status-message",children:m}):null]}),e.jsx(H,{user:a})]})}export{se as DashboardPage};
