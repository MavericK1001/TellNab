generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  hasPassword  Boolean  @default(true)
  bio          String?
  avatarUrl    String?
  coverImageUrl String?
  authProvider String   @default("LOCAL")
  googleSub    String?  @unique
  appleSub     String?  @unique
  role         String   @default("MEMBER")
  isActive     Boolean  @default(true)
  walletPaidCents Int   @default(0)
  walletEarnedCents Int @default(0)
  walletLifetimeEarnedCents Int @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  advices              Advice[]                  @relation("AdviceAuthor")
  comments             AdviceComment[]
  moderatedAdvices     Advice[]                  @relation("AdviceModerator")
  moderationActions    AdviceModerationAction[]
  createdConversations Conversation[]            @relation("ConversationCreator")
  conversationLinks    ConversationParticipant[]
  sentMessages         Message[]
  adviceFollows        AdviceFollow[]
  adviceReactions      AdviceReaction[]
  savedAdvices         SavedAdvice[]
  notifications        Notification[]
  boostOrders          AdviceBoostOrder[]
  priorityOrders       AdvicePriorityOrder[]
  advisorProfile       AdvisorProfile?
  advisorFollowers     AdvisorFollow[] @relation("AdvisorFollowedAdvisor")
  followedAdvisors     AdvisorFollow[] @relation("AdvisorFollower")
  walletTransactions   WalletTransaction[]
  walletActions        WalletTransaction[] @relation("WalletTransactionActor")
  badges               UserBadge[]
  badgesAwarded        UserBadge[] @relation("UserBadgeAwarder")
  adminAuditEntries    AdminAuditLog[] @relation("AdminActor")
  adminAuditTargets    AdminAuditLog[] @relation("AdminTarget")
  createdGroups        DiscussionGroup[] @relation("DiscussionGroupOwner")
  groupMemberships     GroupMembership[]
  groupJoinRequests    GroupJoinRequest[] @relation("GroupJoinRequester")
  reviewedJoinRequests GroupJoinRequest[] @relation("GroupJoinReviewer")
  groupModerationActions GroupModerationAction[]
  resolvedSupportTickets SupportTicket[] @relation("SupportTicketResolver")
  assignedSupportTickets SupportTicket[] @relation("SupportTicketAssignee")
  supportTicketMessages SupportTicketMessage[] @relation("SupportTicketMessageSender")

  // Support 2.0 RBAC + ticketing relations
  userRoles              UserRole[]
  ticketsAsCustomer      Ticket[]            @relation("TicketCustomer")
  ticketsAsAssignedAgent Ticket[]            @relation("TicketAssignedAgent")
  ticketMessagesV2       TicketMessage[]     @relation("TicketMessageSenderV2")
  ticketInternalNotes    TicketInternalNote[] @relation("TicketInternalNoteAuthor")
  ticketActivities       TicketActivityLog[]  @relation("TicketActivityPerformer")
}

model Role {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  isSystem    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  roles RolePermission[]
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
}

model Department {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  tickets     Ticket[]
  slaPolicies SlaPolicy[]
}

model Ticket {
  id              String   @id @default(cuid())
  ticketNumber    String   @unique
  subject         String
  description     String
  status          String   @default("NEW")
  priority        String   @default("MEDIUM")
  departmentId    String
  customerId      String
  assignedAgentId String?
  escalatedAt     DateTime?
  closedAt        DateTime?
  reopenedAt      DateTime?
  firstResponseAt DateTime?
  resolutionAt    DateTime?
  slaDueAt        DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  department    Department @relation(fields: [departmentId], references: [id])
  customer      User       @relation("TicketCustomer", fields: [customerId], references: [id])
  assignedAgent User?      @relation("TicketAssignedAgent", fields: [assignedAgentId], references: [id])

  messages      TicketMessage[]
  internalNotes TicketInternalNote[]
  activityLogs  TicketActivityLog[]
  tags          TicketTag[]

  @@index([status, priority, createdAt])
  @@index([departmentId, status, updatedAt])
  @@index([assignedAgentId, status, slaDueAt])
  @@index([customerId, createdAt])
}

model TicketMessage {
  id         String   @id @default(cuid())
  ticketId   String
  senderId   String
  senderRole String
  body       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User   @relation("TicketMessageSenderV2", fields: [senderId], references: [id])

  @@index([ticketId, createdAt])
}

model TicketInternalNote {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  note      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation("TicketInternalNoteAuthor", fields: [userId], references: [id])

  @@index([ticketId, createdAt])
}

model TicketActivityLog {
  id          String   @id @default(cuid())
  ticketId    String
  action      String
  performedBy String
  metadata    String?
  createdAt   DateTime @default(now())

  ticket    Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  performer User   @relation("TicketActivityPerformer", fields: [performedBy], references: [id])

  @@index([ticketId, createdAt])
  @@index([performedBy, createdAt])
}

model Tag {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  tickets TicketTag[]
}

model TicketTag {
  id        String   @id @default(cuid())
  ticketId  String
  tagId     String
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([ticketId, tagId])
  @@index([tagId])
}

model SlaPolicy {
  id                   String   @id @default(cuid())
  departmentId         String
  priority             String
  firstResponseMinutes Int
  resolutionMinutes    Int
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([departmentId, priority])
}

model SupportTicket {
  id                String   @id @default(cuid())
  type              String
  priority          String   @default("NORMAL")
  status            String   @default("OPEN")
  requesterName     String
  requesterEmail    String
  subject           String
  message           String
  pageUrl           String?
  firstResponseDueAt DateTime?
  firstResponseAt   DateTime?
  ipAddress         String?
  userAgent         String?
  internalNote      String?
  resolutionSummary String?
  resolvedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  resolvedById String?
  resolvedBy   User? @relation("SupportTicketResolver", fields: [resolvedById], references: [id])

  assignedToId String?
  assignedTo   User? @relation("SupportTicketAssignee", fields: [assignedToId], references: [id])

  messages SupportTicketMessage[]

  @@index([status, createdAt])
  @@index([priority, status, createdAt])
  @@index([type, createdAt])
  @@index([requesterEmail, createdAt])
  @@index([assignedToId, status, updatedAt])
}

model SupportTicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  senderType  String
  senderName  String?
  senderEmail String?
  senderUserId String?
  body        String
  createdAt   DateTime @default(now())

  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderUser  User? @relation("SupportTicketMessageSender", fields: [senderUserId], references: [id])

  @@index([ticketId, createdAt])
  @@index([senderType, createdAt])
}

model Category {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  advices Advice[]
}

model Advice {
  id          String   @id @default(cuid())
  title       String
  body        String
  status      String   @default("PENDING")
  visibility  String   @default("PUBLIC")
  isLocked    Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  isSpam      Boolean  @default(false)
  isCrisisFlagged Boolean @default(false)
  crisisKeywords String?
  isBoostActive Boolean @default(false)
  helpfulCount Int      @default(0)
  viewCount    Int      @default(0)
  priorityTier String   @default("NORMAL")
  priorityScore Int     @default(0)
  boostActivatedAt DateTime?
  boostExpiresAt DateTime?
  holdReason  String?
  categoryId  String?
  groupId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  moderatedAt DateTime?

  authorId String
  author   User @relation("AdviceAuthor", fields: [authorId], references: [id])

  moderatedById String?
  moderatedBy   User? @relation("AdviceModerator", fields: [moderatedById], references: [id])

  category Category? @relation(fields: [categoryId], references: [id])
  group    DiscussionGroup? @relation(fields: [groupId], references: [id])

  comments AdviceComment[]
  actions  AdviceModerationAction[]
  follows  AdviceFollow[]
  reactions AdviceReaction[]
  saves     SavedAdvice[]
  notifications Notification[]
  boostOrders AdviceBoostOrder[]
  priorityOrders AdvicePriorityOrder[]

  @@index([status, visibility, createdAt])
  @@index([status, categoryId, createdAt])
  @@index([priorityTier, createdAt])
}

model DiscussionGroup {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  visibility  String   @default("PUBLIC")
  isActive    Boolean  @default(true)
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner             User                   @relation("DiscussionGroupOwner", fields: [ownerId], references: [id])
  memberships       GroupMembership[]
  joinRequests      GroupJoinRequest[]
  moderationActions GroupModerationAction[]
  advices           Advice[]
}

model GroupMembership {
  id       String   @id @default(cuid())
  role     String   @default("MEMBER")
  isMuted  Boolean  @default(false)
  joinedAt DateTime @default(now())

  groupId String
  group   DiscussionGroup @relation(fields: [groupId], references: [id])

  userId String
  user   User @relation(fields: [userId], references: [id])

  @@unique([groupId, userId])
  @@index([userId, joinedAt])
}

model GroupJoinRequest {
  id             String   @id @default(cuid())
  status         String   @default("PENDING")
  message        String?
  decisionReason String?
  requestedAt    DateTime @default(now())
  reviewedAt     DateTime?

  groupId String
  group   DiscussionGroup @relation(fields: [groupId], references: [id])

  requesterId String
  requester   User @relation("GroupJoinRequester", fields: [requesterId], references: [id])

  reviewedById String?
  reviewedBy   User? @relation("GroupJoinReviewer", fields: [reviewedById], references: [id])

  @@index([groupId, status, requestedAt])
  @@unique([groupId, requesterId, status])
}

model GroupModerationAction {
  id        String   @id @default(cuid())
  action    String
  reason    String?
  metadata  String?
  createdAt DateTime @default(now())

  groupId String
  group   DiscussionGroup @relation(fields: [groupId], references: [id])

  actorId String
  actor   User @relation(fields: [actorId], references: [id])

  @@index([groupId, createdAt])
}

model AdviceBoostOrder {
  id          String   @id @default(cuid())
  amountCents Int
  currency    String   @default("USD")
  status      String   @default("PENDING")
  provider    String   @default("MOCK")
  providerRef String?
  boostDays   Int
  paidAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adviceId String
  advice   Advice @relation(fields: [adviceId], references: [id])

  userId String
  user   User @relation(fields: [userId], references: [id])

  @@index([adviceId, createdAt])
  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model AdviceFollow {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  adviceId String
  advice   Advice @relation(fields: [adviceId], references: [id])

  userId String
  user   User @relation(fields: [userId], references: [id])

  @@unique([adviceId, userId])
}

model AdviceReaction {
  id        String   @id @default(cuid())
  type      String   @default("HELPFUL")
  createdAt DateTime @default(now())

  adviceId String
  advice   Advice @relation(fields: [adviceId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([adviceId, userId, type])
  @@index([adviceId, type])
}

model SavedAdvice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  adviceId String
  advice   Advice @relation(fields: [adviceId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([adviceId, userId])
  @@index([userId, createdAt])
}

model AdvisorProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  displayName      String
  avatarUrl        String?
  bio              String?
  specialties      String   @default("[]")
  isVerified       Boolean  @default(false)
  responseTimeMins Int      @default(1440)
  totalReplies     Int      @default(0)
  ratingAvg        Float    @default(0)
  ratingCount      Int      @default(0)
  followersCount   Int      @default(0)
  isPublic         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AdvisorFollow {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  followerId String
  follower   User @relation("AdvisorFollower", fields: [followerId], references: [id], onDelete: Cascade)

  advisorId String
  advisor   User @relation("AdvisorFollowedAdvisor", fields: [advisorId], references: [id], onDelete: Cascade)

  @@unique([followerId, advisorId])
  @@index([advisorId, createdAt])
}

model AdvicePriorityOrder {
  id          String   @id @default(cuid())
  amountCents Int
  currency    String   @default("USD")
  status      String   @default("PENDING")
  provider    String   @default("PENDING_GATEWAY")
  providerRef String?
  queueTier   String   @default("PRIORITY")
  paidAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adviceId String
  advice   Advice @relation(fields: [adviceId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([adviceId, createdAt])
  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model AdviceComment {
  id        String   @id @default(cuid())
  body      String
  messageType String @default("TEXT")
  audioUrl   String?
  audioDurationSec Int?
  transcript String?
  createdAt DateTime @default(now())

  adviceId String
  advice   Advice @relation(fields: [adviceId], references: [id])

  authorId String
  author   User @relation(fields: [authorId], references: [id])

  parentId String?
  parent   AdviceComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  AdviceComment[] @relation("CommentReplies")
  notifications Notification[]
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  body      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id])

  adviceId String?
  advice   Advice? @relation(fields: [adviceId], references: [id])

  commentId String?
  comment   AdviceComment? @relation(fields: [commentId], references: [id])

  @@index([userId, createdAt])
}

model AdviceModerationAction {
  id        String   @id @default(cuid())
  action    String
  note      String?
  createdAt DateTime @default(now())

  adviceId String
  advice   Advice @relation(fields: [adviceId], references: [id])

  moderatorId String
  moderator   User @relation(fields: [moderatorId], references: [id])
}

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String
  createdBy   User @relation("ConversationCreator", fields: [createdById], references: [id])

  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id       String   @id @default(cuid())
  joinedAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])

  userId String
  user   User @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

model Message {
  id        String   @id @default(cuid())
  body      String
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])

  senderId String
  sender   User @relation(fields: [senderId], references: [id])
}

model WalletTransaction {
  id                   String   @id @default(cuid())
  amountCents          Int
  balanceType          String
  direction            String
  reason               String
  source               String   @default("SYSTEM")
  resultingPaidCents   Int
  resultingEarnedCents Int
  createdAt            DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id])

  performedById String?
  performedBy   User? @relation("WalletTransactionActor", fields: [performedById], references: [id])

  @@index([userId, createdAt])
  @@index([source, createdAt])
}

model BadgeDefinition {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String
  icon        String   @default("üèÖ")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  awards UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  source    String   @default("AUTO")
  reason    String?
  isVisible Boolean  @default(true)
  awardedAt DateTime @default(now())

  userId String
  user   User @relation(fields: [userId], references: [id])

  badgeId String
  badge   BadgeDefinition @relation(fields: [badgeId], references: [id])

  awardedById String?
  awardedBy   User? @relation("UserBadgeAwarder", fields: [awardedById], references: [id])

  @@unique([userId, badgeId])
  @@index([badgeId, awardedAt])
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  action    String
  reason    String
  metadata  String?
  createdAt DateTime @default(now())

  adminId String
  admin   User @relation("AdminActor", fields: [adminId], references: [id])

  targetUserId String?
  targetUser   User? @relation("AdminTarget", fields: [targetUserId], references: [id])

  @@index([adminId, createdAt])
  @@index([targetUserId, createdAt])
}
